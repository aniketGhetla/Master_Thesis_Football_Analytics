{% extends "base.html" %}
{% block content %}

<section class="upload-wrap">
  <header class="page-head">
    <div>
      <h2>Upload & Ingest Match</h2>
      <p class="sub">Provide the three Sportec XML files. We‚Äôll validate, merge, and write them into Postgres for analysis.</p>
    </div>
  </header>

  <div class="grid">
    <!-- FORM CARD -->
    <div class="card">
      <form id="ingest-form"
            action="{{ url_for('upload.handle_upload') }}"
            method="post"
            enctype="multipart/form-data"
            novalidate>

        <!-- Context row -->
        <div class="row two">
          <label class="field">
            <span class="lbl">Provider</span>
            <select name="provider" class="input">
              <option value="sportec" selected>sportec</option>
            </select>
          </label>

          <label class="field">
            <span class="lbl">Unique Match ID (optional)</span>
            <input class="input" type="text" name="unique_match_id" placeholder="e.g. 2023-05-27_FCK_1-2_FCB">
          </label>
        </div>

        <!-- Files -->
        <div class="row three">
          <!-- Tracking -->
          <div class="drop field" id="dz-tracking" role="button" tabindex="0" aria-label="Tracking XML drop zone">
            <div class="dz-icon">üì°</div>
            <div class="dz-body">
              <div class="dz-title">Tracking XML</div>
              <div class="dz-sub">Drag & drop or click to browse</div>
              <div class="dz-file" id="fn-tracking">No file selected</div>
            </div>
            <input id="in-tracking"
                   class="file-input"
                   type="file"
                   name="tracking_file"
                   accept=".xml,text/xml"
                   required>
          </div>

          <!-- Event -->
          <div class="drop field" id="dz-event" role="button" tabindex="0" aria-label="Event XML drop zone">
            <div class="dz-icon">üìù</div>
            <div class="dz-body">
              <div class="dz-title">Event XML</div>
              <div class="dz-sub">Drag & drop or click to browse</div>
              <div class="dz-file" id="fn-event">No file selected</div>
            </div>
            <input id="in-event"
                   class="file-input"
                   type="file"
                   name="event_file"
                   accept=".xml,text/xml"
                   required>
          </div>

          <!-- Meta -->
          <div class="drop field" id="dz-meta" role="button" tabindex="0" aria-label="Meta XML drop zone">
            <div class="dz-icon">üóÇÔ∏è</div>
            <div class="dz-body">
              <div class="dz-title">Meta XML</div>
              <div class="dz-sub">Drag & drop or click to browse</div>
              <div class="dz-file" id="fn-meta">No file selected</div>
            </div>
            <input id="in-meta"
                   class="file-input"
                   type="file"
                   name="meta_file"
                   accept=".xml,text/xml"
                   required>
          </div>
        </div>

        <!-- Options -->
        <div class="row two">
          <label class="check">
            <input type="checkbox" name="validate_only" value="1">
            <span>Validate only (don‚Äôt write to DB)</span>
          </label>
          <label class="check">
            <input type="checkbox" name="overwrite" value="1">
            <span>Overwrite existing rows for this match (if any)</span>
          </label>
        </div>

        <!-- Actions -->
        <div class="actions">
          <button id="btn-submit" class="btn primary" type="submit">üöÄ Start Ingestion</button>
          <button class="btn ghost" type="reset">Reset</button>
        </div>
      </form>
    </div>

    <!-- HELP CARD -->
    <aside class="card help">
      <h3>Upload tips</h3>
      <ul class="tips">
        <li>Expected file types: <code>.xml</code> (Sportec tracking, event, and meta).</li>
        <li>Keep files from the same match aligned (same provider & match metadata).</li>
        <li><b>Unique Match ID</b> is optional; if omitted we derive it from meta.</li>
        <li>Use <b>Validate only</b> to sanity-check files before writing.</li>
      </ul>

      <h4>Sample naming</h4>
      <pre class="code">tracking_2023-05-27_FCK_FCB.xml
events_2023-05-27_FCK_FCB.xml
meta_2023-05-27_FCK_FCB.xml</pre>

      <h4>What happens next?</h4>
      <ol class="tips">
        <li>Files are parsed and normalized.</li>
        <li>Event & tracking streams are merged.</li>
        <li>Rows are written to temporary Postgres tables.</li>
        <li>You‚Äôll see a success summary (rows written / any warnings).</li>
      </ol>
    </aside>
  </div>
</section>

<!-- Page styles (scoped) -->
<style>
.upload-wrap { display: grid; gap: 16px; }
.page-head h2 { margin: 0 0 6px 0; }
.page-head .sub { color: var(--muted, #94a3b8); margin: 0; }

.grid { display: grid; grid-template-columns: 2fr 1fr; gap: 16px; }
@media (max-width: 1024px){ .grid { grid-template-columns: 1fr; } }

.card {
  background: var(--panel, #151a21);
  border: 1px solid var(--line, #2a2f36);
  border-radius: 12px;
  padding: 16px;
}

.row { display: grid; gap: 12px; margin-top: 10px; }
.row.two { grid-template-columns: repeat(2, 1fr); }
.row.three { grid-template-columns: repeat(3, 1fr); }
@media (max-width: 1024px){
  .row.two, .row.three { grid-template-columns: 1fr; }
}

.field .lbl { font-size: 12px; color: var(--muted, #94a3b8); display: block; margin-bottom: 6px; }
.input, select.input, input.input {
  background: #0c0f14;
  border: 1px solid var(--line, #2a2f36);
  color: var(--text, #e5e7eb);
  border-radius: 10px;
  padding: 10px 12px;
  width: 100%;
  outline: none;
}
.input:focus { border-color: #3b82f6; }

.drop {
  position: relative;
  border: 1px dashed #334155;
  border-radius: 12px;
  background: rgba(16, 21, 28, 0.6);
  padding: 14px 12px;
  display: flex; gap: 10px; align-items: center;
  cursor: pointer;
  transition: border-color .15s ease, background .15s ease;
  min-height: 110px;
}
.drop:hover, .drop:focus { border-color: #60a5fa; background: rgba(16, 21, 28, 0.8); outline: none; }
.drop.dragover { border-color: #22c55e; background: rgba(34, 197, 94, 0.08); }
.drop .dz-icon { font-size: 28px; }
.drop .dz-title { font-weight: 600; }
.drop .dz-sub { color: var(--muted, #94a3b8); font-size: 12px; }
.drop .dz-file { margin-top: 6px; font-size: 12px; color: #cbd5e1; word-break: break-all; }
.file-input { position: absolute; inset: 0; width: 100%; height: 100%; opacity: 0; cursor: pointer; }

.check { display: flex; align-items: center; gap: 8px; font-size: 14px; color: var(--text, #e5e7eb); }
.check input { transform: translateY(1px); }

.actions { display: flex; gap: 10px; margin-top: 14px; }
.btn {
  appearance: none; border-radius: 10px; padding: 10px 14px;
  border: 1px solid var(--line, #2a2f36); background: #10151c; color: var(--text, #e5e7eb);
  cursor: pointer;
}
.btn.primary { background: linear-gradient(180deg, #2563eb, #1d4ed8); border-color: #1e40af; }
.btn.ghost   { background: transparent; }

.help h3 { margin: 4px 0 10px; }
.help h4 { margin: 14px 0 6px; font-size: 14px; color: #cbd5e1; }
.tips { margin: 0; padding-left: 1.1rem; color: var(--text, #e5e7eb); }
.code {
  background: #0b1220; border: 1px solid #1f2937; color: #c9d1d9;
  padding: 10px; border-radius: 10px; overflow-x: auto;
}
</style>

<!-- Minimal JS for drag & drop + filename preview + submit UX -->
<script>
(function () {
  function bindZone(zoneId, inputId, labelId) {
    const zone  = document.getElementById(zoneId);
    const input = document.getElementById(inputId);
    const label = document.getElementById(labelId);

    function setName(file) {
      if (!file) { label.textContent = "No file selected"; return; }
      const kb = (file.size/1024).toFixed(1);
      label.textContent = `${file.name} ‚Ä¢ ${kb} KB`;
    }

    zone.addEventListener('click', () => input.click());
    zone.addEventListener('keydown', (e) => {
      if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); input.click(); }
    });

    zone.addEventListener('dragover', (e) => { e.preventDefault(); zone.classList.add('dragover'); });
    zone.addEventListener('dragleave', () => zone.classList.remove('dragover'));
    zone.addEventListener('drop', (e) => {
      e.preventDefault(); zone.classList.remove('dragover');
      if (e.dataTransfer.files && e.dataTransfer.files[0]) {
        input.files = e.dataTransfer.files;
        setName(input.files[0]);
      }
    });

    input.addEventListener('change', () => setName(input.files[0]));
  }

  bindZone('dz-tracking','in-tracking','fn-tracking');
  bindZone('dz-event','in-event','fn-event');
  bindZone('dz-meta','in-meta','fn-meta');

  const form = document.getElementById('ingest-form');
  const submitBtn = document.getElementById('btn-submit');
  form.addEventListener('submit', () => {
    submitBtn.disabled = true;
    submitBtn.textContent = '‚è≥ Ingesting‚Ä¶';
    submitBtn.setAttribute('aria-busy','true');
  });
})();
</script>

{% endblock %}
